name: Deploy Node.js Backend to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Bundle code WITHOUT node_modules, storage, .git, .env
      # Use only tracked files to avoid "file changed as we read it"
      - name: ğŸ“¦ Create backend.tar.gz (tracked files only)
        run: |
          git ls-files -z \
            | grep -zvE '(^\.env$|^storage/|^node_modules/)' \
            | tar --null -czvf backend.tar.gz -T -

      - name: ğŸšš Upload bundle to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT }}
          source: "backend.tar.gz"
          target: "/home/api.sevenunique.com/"

      - name: ğŸ” Deploy on EC2 and Restart PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USERNAME }}
          key: ${{ secrets.BACKEND_SSH_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT }}
          script: |
            set -e
            APP_DIR="/home/api.sevenunique.com/Crm_Backnd"
            TAR_FILE="/home/api.sevenunique.com/backend.tar.gz"
            OWNER_USER="finuniquerummy"
            OWNER_GROUP="finuniquerummy"

            echo "ğŸ” Backing up .env if present"
            if [ -f "$APP_DIR/.env" ]; then
              cp "$APP_DIR/.env" "/home/api.sevenunique.com/.env_backup"
            fi

            echo "ğŸ›¡ï¸ Taking full code backup with timestamp"
            TS=$(date +%Y%m%d_%H%M%S)
            mkdir -p /home/api.sevenunique.com/backups
            cp -r "$APP_DIR" "/home/api.sevenunique.com/backups/Crm_Backnd_$TS"

            echo "ğŸ§¼ Preserve storage/, wipe rest of code"
            mkdir -p "$APP_DIR/storage_tmp_keep"
            cp -r "$APP_DIR/storage" "$APP_DIR/storage_tmp_keep" 2>/dev/null || true
            rm -rf "$APP_DIR"/*
            mv "$APP_DIR/storage_tmp_keep/storage" "$APP_DIR/storage" 2>/dev/null || true
            rm -rf "$APP_DIR/storage_tmp_keep"

            echo "ğŸ“¦ Extracting new code"
            tar -xzvf "$TAR_FILE" -C "$APP_DIR"
            rm "$TAR_FILE"

            echo "â™»ï¸ Restoring .env"
            if [ -f "/home/api.sevenunique.com/.env_backup" ]; then
              mv "/home/api.sevenunique.com/.env_backup" "$APP_DIR/.env"
            fi

            echo "ğŸ‘‘ Fixing ownership"
            chown -R $OWNER_USER:$OWNER_GROUP "$APP_DIR"

            echo "ğŸ“¦ Installing dependencies in server"
            cd "$APP_DIR"
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --legacy-peer-deps
            fi

            echo "ğŸš€ Restarting PM2 service"
            pm2 restart api.sevenunique.com || pm2 start server.js --name api.sevenunique.com

            echo "âœ… Deployment complete"
